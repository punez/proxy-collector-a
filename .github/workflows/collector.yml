name: Universal Collector A

on:
  workflow_dispatch:
  schedule:
    - cron: "15 */4 * * *"

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install basic tools
        run: |
          sudo apt update
          sudo apt install -y curl jq netcat-openbsd

      - name: Fetch Registry
        run: |
          curl -s https://raw.githubusercontent.com/punez/proxy-registry/main/registry.json -o registry.json

      - name: Extract Sources
        run: |
          jq -r '.shards["collector-a"][]' registry.json > sources.txt
          echo "Sources loaded:"
          cat sources.txt

      - name: Collect Everything
        run: |
          rm -f merged_raw.txt
          touch merged_raw.txt

          while read url; do
            [ -z "$url" ] && continue
            echo "Downloading $url"

            content=$(curl -L -s --max-time 20 "$url" || echo "")

            [ -z "$content" ] && continue

            # original
            echo "$content" >> merged_raw.txt
            echo "" >> merged_raw.txt

            # try base64 decode once
            decoded=$(echo "$content" | base64 -d 2>/dev/null || echo "")
            if [ -n "$decoded" ]; then
              echo "$decoded" >> merged_raw.txt
              echo "" >> merged_raw.txt
            fi

          done < sources.txt

      - name: Extract All Possible Links
        run: |
          rm -f extracted.txt
          touch extracted.txt

          # direct protocol lines
          grep -aEo '(vmess|vless|trojan|ss|ssr|hy2|tuic)://[^"]+' merged_raw.txt >> extracted.txt || true

          # try to pull strings from JSON
          jq -r '..|strings?' merged_raw.txt 2>/dev/null | \
          grep -aE '(vmess|vless|trojan|ss|ssr|hy2|tuic)://' >> extracted.txt || true

          sort -u extracted.txt -o extracted.txt

          echo "Total extracted:"
          wc -l extracted.txt

      - name: TCP Alive Test (Simple)
        run: |
          rm -f alive.txt
          touch alive.txt

          cat extracted.txt | xargs -I {} -P 50 bash -c '
            line="{}"
            hp=$(echo "$line" | grep -oE "[a-zA-Z0-9\.-]+:[0-9]+" | head -n1)

            if [ -n "$hp" ]; then
              host=$(echo $hp | cut -d":" -f1)
              port=$(echo $hp | cut -d":" -f2)

              timeout 3 nc -z $host $port 2>/dev/null
              if [ $? -eq 0 ]; then
                echo "$line" >> alive.txt
              fi
            fi
          ' || true

          sort -u alive.txt -o alive.txt

          echo "Alive count:"
          wc -l alive.txt

      - name: Commit Alive
        run: |
          git config --global user.name "collector-a-bot"
          git config --global user.email "bot@github.com"
          git add alive.txt
          git commit -m "update alive list" || echo "No changes"
          git push || true
